<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîó Ecosystem Matching System Test</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1400px; 
            margin: 20px auto; 
            padding: 20px; 
            background: #0f1419;
            color: #e6f1ff;
        }
        .container { background: #1a1f29; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
        .section { margin-bottom: 40px; padding: 25px; background: #252b36; border-radius: 12px; border-left: 4px solid #f97316; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #f97316; }
        input, textarea, select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #374151; 
            border-radius: 8px; 
            font-size: 14px;
            background: #1f2937;
            color: #e6f1ff;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { 
            outline: none; 
            border-color: #f97316; 
        }
        button { 
            background: #f97316; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background: #ea580c; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        button.secondary { background: #374151; }
        button.secondary:hover { background: #4b5563; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }
        .result { margin-top: 20px; padding: 20px; border-radius: 8px; }
        .success { background: #064e3b; color: #a7f3d0; border: 2px solid #059669; }
        .error { background: #7f1d1d; color: #fca5a5; border: 2px solid #dc2626; }
        .warning { background: #92400e; color: #fed7aa; border: 2px solid #d97706; }
        .info { background: #1e3a8a; color: #bfdbfe; border: 2px solid #3b82f6; }
        pre { 
            background: #111827; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            border: 1px solid #374151;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #374151; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 500; }
        .tab.active { border-bottom-color: #f97316; color: #f97316; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .status-pending { background: #fbbf24; }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .opportunity-card { 
            background: #1f2937; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #374151; 
            margin-bottom: 15px;
        }
        .score-bar { 
            width: 100%; 
            height: 8px; 
            background: #374151; 
            border-radius: 4px; 
            overflow: hidden; 
            margin-top: 5px;
        }
        .score-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #dc2626, #f59e0b, #10b981); 
            transition: width 0.3s ease;
        }
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .metric { background: #111827; padding: 12px; border-radius: 6px; text-align: center; }
        .metric-value { font-size: 18px; font-weight: bold; color: #f97316; }
        .metric-label { font-size: 12px; color: #9ca3af; margin-top: 4px; }
        h1, h2, h3 { color: #f97316; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Ecosystem Matching System</h1>
        <p>Test the advanced backlink opportunity generation and automatic placement system</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('opportunity-generator')">üéØ Opportunity Generator</div>
            <div class="tab" onclick="switchTab('placement-engine')">üöÄ Automatic Placement</div>
            <div class="tab" onclick="switchTab('system-monitor')">üìä System Monitor</div>
        </div>

        <!-- Opportunity Generator Tab -->
        <div id="opportunity-generator" class="tab-content active">
            <div class="section">
                <h3>üéØ Generate Placement Opportunities</h3>
                <p>Test the enhanced matching engine with niche proximity, DA weighting, and geographic relevance</p>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="contentId">Content ID:</label>
                        <input type="text" id="contentId" placeholder="UUID from tracked_content table">
                        <small style="color: #9ca3af;">Get this from your Supabase tracked_content table</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="userId">User ID:</label>
                        <input type="text" id="userId" placeholder="UUID from users table">
                        <small style="color: #9ca3af;">Content owner's user ID</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="forceReprocess"> Force Reprocess (ignore existing opportunities)
                    </label>
                </div>
                
                <button onclick="generateOpportunities()">üîç Generate Opportunities</button>
                <button class="secondary" onclick="getContentIds()">üìã Get Sample Content IDs</button>
            </div>
            
            <div id="opportunities-result"></div>
        </div>

        <!-- Automatic Placement Tab -->
        <div id="placement-engine" class="tab-content">
            <div class="section">
                <h3>üöÄ Automatic Placement Engine</h3>
                <p>Test WordPress API integration and automatic link insertion</p>
                
                <div class="grid">
                    <div class="form-group">
                        <label for="opportunityId">Opportunity ID:</label>
                        <input type="text" id="opportunityId" placeholder="UUID from placement_opportunities table">
                        <small style="color: #9ca3af;">Get this from generated opportunities</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="placementUserId">User ID (optional):</label>
                        <input type="text" id="placementUserId" placeholder="Override user ID">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="manualOverride"> Manual Override (bypass approval requirement)
                    </label>
                </div>
                
                <button onclick="attemptPlacement()">üöÄ Attempt Automatic Placement</button>
                <button class="secondary" onclick="getPendingOpportunities()">üìã Get Pending Opportunities</button>
            </div>
            
            <div id="placement-result"></div>
        </div>

        <!-- System Monitor Tab -->
        <div id="system-monitor" class="tab-content">
            <div class="section">
                <h3>üìä System Performance Monitor</h3>
                <p>Monitor ecosystem matching performance and placement success rates</p>
                
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="total-opportunities">-</div>
                        <div class="metric-label">Total Opportunities</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="success-rate">-</div>
                        <div class="metric-label">Placement Success Rate</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="avg-score">-</div>
                        <div class="metric-label">Avg Match Score</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="auto-approved">-</div>
                        <div class="metric-label">Auto-Approved</div>
                    </div>
                </div>
                
                <button onclick="refreshMetrics()">üîÑ Refresh Metrics</button>
                <button class="secondary" onclick="exportData()">üìä Export Data</button>
            </div>
            
            <div id="monitor-result"></div>
        </div>
        
        <!-- Quick Links -->
        <div class="section">
            <h3>üîó Quick Links</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/editor?table=placement_opportunities" target="_blank" style="display: block; padding: 12px; background: #374151; border-radius: 6px; text-decoration: none; color: #e6f1ff;">
                    üéØ View Placement Opportunities
                </a>
                <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/editor?table=partner_relationships" target="_blank" style="display: block; padding: 12px; background: #374151; border-radius: 6px; text-decoration: none; color: #e6f1ff;">
                    ü§ù Partner Relationships
                </a>
                <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/editor?table=placement_attempts" target="_blank" style="display: block; padding: 12px; background: #374151; border-radius: 6px; text-decoration: none; color: #e6f1ff;">
                    üìä Placement Attempts
                </a>
                <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/logs/functions" target="_blank" style="display: block; padding: 12px; background: #374151; border-radius: 6px; text-decoration: none; color: #e6f1ff;">
                    üìù Function Logs
                </a>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://sljlwvrtwqmhmjunyplr.supabase.co/functions/v1';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsamx3dnJ0d3FtaG1qdW55cGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTkzMDMsImV4cCI6MjA2NjQzNTMwM30.xJNGPIQ51XpdekFSQQ0Ymk4G3A86PZ4KRqKptRb-ozU';

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            const statusClass = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            const statusIcon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            container.innerHTML = `
                <div class="result ${statusClass}">
                    <h3>${statusIcon} ${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
                    ${content}
                </div>
            `;
            container.scrollIntoView({ behavior: 'smooth' });
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ANON_KEY}`
                },
                body: body ? JSON.stringify(body) : null
            });
            return { response, data: await response.json() };
        }

        async function generateOpportunities() {
            const contentId = document.getElementById('contentId').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const forceReprocess = document.getElementById('forceReprocess').checked;

            if (!contentId || !userId) {
                showResult('opportunities-result', 'Please provide both Content ID and User ID', 'error');
                return;
            }

            showResult('opportunities-result', '<p>üîç Generating opportunities...</p>', 'info');

            try {
                const { response, data } = await apiCall('/ecosystem-matcher', 'POST', {
                    contentId,
                    userId,
                    forceReprocess
                });

                if (response.ok) {
                    const opportunities = data.opportunities_created || 0;
                    const autoApproved = data.auto_approved || 0;
                    const avgScore = data.average_score ? (data.average_score * 100).toFixed(1) : 'N/A';
                    
                    let content = `
                        <h4>üéâ Opportunities Generated Successfully!</h4>
                        <div class="metric-grid">
                            <div class="metric">
                                <div class="metric-value">${opportunities}</div>
                                <div class="metric-label">Opportunities Created</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${autoApproved}</div>
                                <div class="metric-label">Auto-Approved</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${avgScore}%</div>
                                <div class="metric-label">Average Score</div>
                            </div>
                        </div>
                    `;

                    if (data.top_opportunity) {
                        content += `
                            <div class="opportunity-card">
                                <h4>üèÜ Top Opportunity</h4>
                                <p><strong>Target User:</strong> ${data.top_opportunity.target_user_id}</p>
                                <p><strong>Score:</strong> ${(data.top_opportunity.score * 100).toFixed(1)}%</p>
                                <p><strong>Anchor Text:</strong> "${data.top_opportunity.suggested_anchor_text}"</p>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${data.top_opportunity.score * 100}%"></div>
                                </div>
                            </div>
                        `;
                    }

                    content += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    showResult('opportunities-result', content, 'success');
                } else {
                    showResult('opportunities-result', `
                        <h4>Generation Failed</h4>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                showResult('opportunities-result', `<h4>Network Error</h4><p>${error.message}</p>`, 'error');
            }
        }

        async function attemptPlacement() {
            const opportunityId = document.getElementById('opportunityId').value.trim();
            const userId = document.getElementById('placementUserId').value.trim();
            const manualOverride = document.getElementById('manualOverride').checked;

            if (!opportunityId) {
                showResult('placement-result', 'Please provide an Opportunity ID', 'error');
                return;
            }

            showResult('placement-result', '<p>üöÄ Attempting automatic placement...</p>', 'info');

            try {
                const payload = { opportunityId, manualOverride };
                if (userId) payload.userId = userId;

                const { response, data } = await apiCall('/automatic-placement', 'POST', payload);

                if (response.ok && data.success) {
                    showResult('placement-result', `
                        <h4>üéâ Placement Successful!</h4>
                        <div class="metric-grid">
                            <div class="metric">
                                <div class="metric-value">${data.response_time_ms}ms</div>
                                <div class="metric-label">Response Time</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${data.verification_success ? '‚úÖ' : '‚ùå'}</div>
                                <div class="metric-label">Verification</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${data.credits_charged}</div>
                                <div class="metric-label">Credits Charged</div>
                            </div>
                        </div>
                        <p><strong>Placement URL:</strong> <a href="${data.placement_url}" target="_blank">${data.placement_url}</a></p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'success');
                } else {
                    const refunded = data.credits_refunded ? ` (${data.credits_refunded} credits refunded)` : '';
                    showResult('placement-result', `
                        <h4>Placement Failed${refunded}</h4>
                        <p><strong>Error:</strong> ${data.error}</p>
                        <p><strong>Response Time:</strong> ${data.response_time_ms || 'N/A'}ms</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                showResult('placement-result', `<h4>Network Error</h4><p>${error.message}</p>`, 'error');
            }
        }

        async function getContentIds() {
            showResult('opportunities-result', `
                <h4>üìã Sample Content IDs</h4>
                <p>Go to your <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/editor?table=tracked_content" target="_blank">tracked_content table</a> and copy a content ID and the corresponding user_id.</p>
                <p>You can use the test content we created earlier from your API tests.</p>
            `, 'info');
        }

        async function getPendingOpportunities() {
            showResult('placement-result', `
                <h4>üìã Pending Opportunities</h4>
                <p>Go to your <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/editor?table=placement_opportunities" target="_blank">placement_opportunities table</a> and copy an opportunity ID.</p>
                <p>Look for opportunities with status = 'pending' or 'approved'.</p>
            `, 'info');
        }

        async function refreshMetrics() {
            showResult('monitor-result', '<p>üìä Loading system metrics...</p>', 'info');
            
            // This would call a metrics API endpoint in a real implementation
            showResult('monitor-result', `
                <h4>üìä System Metrics</h4>
                <p>Metrics functionality would connect to your placement_opportunities and placement_attempts tables to show:</p>
                <ul>
                    <li>Total opportunities generated</li>
                    <li>Placement success rates by niche</li>
                    <li>Average response times</li>
                    <li>Partner quality scores</li>
                    <li>Credit transaction volume</li>
                </ul>
                <p>Check the database tables directly for now: 
                   <a href="https://supabase.com/dashboard/project/sljlwvrtwqmhmjunyplr/editor" target="_blank">Supabase Dashboard</a>
                </p>
            `, 'info');
        }

        async function exportData() {
            showResult('monitor-result', `
                <h4>üìä Data Export</h4>
                <p>Export functionality would generate CSV/JSON reports from:</p>
                <ul>
                    <li>placement_opportunities table</li>
                    <li>placement_attempts table</li>
                    <li>credit_transactions table</li>
                    <li>partner_relationships table</li>
                </ul>
                <p>Use the Supabase dashboard to export data for now.</p>
            `, 'info');
        }
    </script>
</body>
</html> 