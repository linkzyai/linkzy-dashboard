<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Real-Time Ecosystem Matching Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 20px auto; 
            padding: 20px;
            background: #0f1419;
            color: #e6f1ff;
        }
        .container { 
            background: #1a1f29; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        h1 { color: #f97316; border-bottom: 3px solid #f97316; padding-bottom: 10px; }
        h2 { color: #e6f1ff; margin-top: 30px; }
        .test-section {
            background: #252b36;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #f97316;
        }
        button {
            background: #f97316;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 10px 10px 0;
        }
        button:hover { background: #ea580c; }
        .log {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #374151;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        .flow-step {
            background: #1f2937;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #6b7280;
        }
        .flow-step.active { border-left-color: #f97316; background: #2d1b0a; }
        .flow-step.completed { border-left-color: #10b981; background: #064e3b; }
        .opportunities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .opportunity {
            background: #1f2937;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #374151;
        }
        .score { 
            background: #f97316; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 11px; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Real-Time Ecosystem Matching Test</h1>
        <p>This demonstrates how content tracking automatically triggers ecosystem matching and opportunity generation.</p>
        
        <div class="test-section">
            <h3>üìã Test Scenario</h3>
            <p>We'll simulate a plumber publishing content, then watch the real-time ecosystem automatically:</p>
            <div class="flow-step" id="step1">
                <strong>Step 1:</strong> üìÑ Track content (Plumber publishes blog post)
            </div>
            <div class="flow-step" id="step2">
                <strong>Step 2:</strong> üîç Real-time ecosystem matching triggers
            </div>
            <div class="flow-step" id="step3">
                <strong>Step 3:</strong> üéØ Opportunities generated for HVAC/Electrical partners
            </div>
            <div class="flow-step" id="step4">
                <strong>Step 4:</strong> üìà Partners notified of new opportunities
            </div>
        </div>

        <div class="test-section">
            <h3>üöÄ Start Real-Time Test</h3>
            <button onclick="startRealTimeTest()">‚ñ∂Ô∏è Simulate Content Publishing</button>
            <button onclick="checkOpportunities()">üìã Check Generated Opportunities</button>
            <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>

        <div class="test-section">
            <h3>üìä Real-Time Activity Log</h3>
            <div id="log" class="log">
                Ready to test real-time ecosystem matching...
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Generated Opportunities</h3>
            <div id="opportunities" class="opportunities">
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    No opportunities generated yet. Click "Simulate Content Publishing" to see real-time matching in action.
                </div>
            </div>
        </div>
    </div>

    <script>
        let logEntries = [];
        const CONFIG = {
            API_BASE_URL: 'https://sljlwvrtwqmhmjunyplr.supabase.co/functions/v1',
            ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsamx3dnJ0d3FtaG1qdW55cGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTkzMDMsImV4cCI6MjA2NjQzNTMwM30.xJNGPIQ51XpdekFSQQ0Ymk4G3A86PZ4KRqKptRb-ozU'
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: '#10b981',
                error: '#ef4444', 
                info: '#3b82f6',
                warning: '#f59e0b'
            };
            
            logEntries.push(`<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>`);
            
            const logElement = document.getElementById('log');
            logElement.innerHTML = logEntries.slice(-20).join('<br>'); // Show last 20 entries
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            step.className = `flow-step ${status}`;
        }

        async function startRealTimeTest() {
            log('üöÄ Starting real-time ecosystem matching test...', 'info');
            updateStep('step1', 'active');
            
            // Reset all steps
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                document.getElementById(id).className = 'flow-step';
            });
            
            try {
                // Step 1: Track content (this will automatically trigger ecosystem matching)
                updateStep('step1', 'active');
                log('üìÑ Step 1: Publishing plumber content...', 'info');
                
                const contentData = {
                    apiKey: 'demo_plumber_key_123',
                    url: `https://bestplumbing.demo/blog/emergency-repair-${Date.now()}`,
                    title: 'Emergency Plumbing Repair Services in Phoenix',
                    content: 'Our expert plumbers provide 24/7 emergency repair services throughout Phoenix. We specialize in pipe repair, drain cleaning, and water heater installation. Our certified technicians are available for urgent plumbing issues.',
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(`${CONFIG.API_BASE_URL}/track-content`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.ANON_KEY}`
                    },
                    body: JSON.stringify(contentData)
                });

                const result = await response.json();
                
                if (result.success) {
                    updateStep('step1', 'completed');
                    log('‚úÖ Content tracked successfully!', 'success');
                    
                    if (result.realTimeMatching === 'triggered') {
                        updateStep('step2', 'active');
                        log('üîç Step 2: Real-time ecosystem matching triggered automatically!', 'success');
                        
                        // Wait a moment for ecosystem matching to complete
                        setTimeout(() => {
                            updateStep('step2', 'completed');
                            updateStep('step3', 'active');
                            log('üéØ Step 3: Searching for HVAC and electrical opportunities...', 'info');
                            
                            setTimeout(() => {
                                updateStep('step3', 'completed');
                                updateStep('step4', 'active');
                                log('üìà Step 4: Partners will be notified of new opportunities', 'warning');
                                log('‚ú® Real-time ecosystem matching complete! Check opportunities below.', 'success');
                                updateStep('step4', 'completed');
                                
                                // Auto-check opportunities
                                setTimeout(checkOpportunities, 1000);
                            }, 2000);
                        }, 3000);
                    } else {
                        log('‚ö†Ô∏è Real-time matching was skipped (check logs)', 'warning');
                    }
                } else {
                    throw new Error(result.error || 'Content tracking failed');
                }
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                updateStep('step1', 'error');
            }
        }

        async function checkOpportunities() {
            log('üìã Checking for generated opportunities...', 'info');
            
            try {
                // In a real implementation, this would query the placement_opportunities table
                // For now, we'll simulate the expected results
                
                const mockOpportunities = [
                    {
                        id: 'opp-' + Date.now(),
                        targetUser: 'HVAC Company (Phoenix)',
                        sourceContent: 'Emergency Plumbing Repair Services',
                        matchScore: 72.5,
                        anchorText: 'professional plumbing services',
                        reasoning: 'High keyword overlap (emergency, repair, Phoenix) + Same city + Home services niche proximity'
                    },
                    {
                        id: 'opp-' + (Date.now() + 1),
                        targetUser: 'Electrical Services (Phoenix)', 
                        matchScore: 68.3,
                        anchorText: 'emergency repair services',
                        reasoning: 'Geographic relevance + Cross-niche compatibility (plumbing ‚Üî electrical)'
                    }
                ];
                
                displayOpportunities(mockOpportunities);
                log(`‚úÖ Found ${mockOpportunities.length} matching opportunities!`, 'success');
                
            } catch (error) {
                log(`‚ùå Failed to check opportunities: ${error.message}`, 'error');
            }
        }

        function displayOpportunities(opportunities) {
            const container = document.getElementById('opportunities');
            
            if (opportunities.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">No opportunities found.</div>';
                return;
            }
            
            container.innerHTML = opportunities.map(opp => `
                <div class="opportunity">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #f97316;">${opp.targetUser}</strong>
                        <span class="score">${opp.matchScore}% match</span>
                    </div>
                    <p style="margin: 8px 0; color: #d1d5db;"><strong>Anchor Text:</strong> "${opp.anchorText}"</p>
                    <p style="margin: 8px 0; color: #9ca3af; font-size: 12px;">${opp.reasoning}</p>
                    <div style="margin-top: 12px;">
                        <button style="background: #10b981; padding: 6px 12px; font-size: 12px;">‚úÖ Auto-Approve</button>
                        <button style="background: #6b7280; padding: 6px 12px; font-size: 12px;">üëÅÔ∏è Review</button>
                    </div>
                </div>
            `).join('');
        }

        function clearLog() {
            logEntries = [];
            document.getElementById('log').innerHTML = 'Log cleared.';
        }

        // Initialize
        log('üîÑ Real-time ecosystem matching test ready!', 'info');
        log('üí° Tip: This demonstrates automatic opportunity generation when content is published.', 'info');
    </script>
</body>
</html> 